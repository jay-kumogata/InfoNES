## ファミコンエミュレータ開発記

### 1999-06-26

_(2021-10-27) 本稿は，2003年8月24日に執筆されました．_

エミュレータを作りはじめた日

はじめに

誰にでも，少年時代に必死に遊んだものを，残しておきたいという気持ちがあるようです[1]．先日，ある老人と話をしたときに，「いまでも，子供の時に鳥をとった遊びをしてみたい」ということをいっていました．しかし，現在では，その鳥をとる遊びは違法で，その夢は叶わないそうです．時は流れて，僕たちの世代では，その残しておきたいものがファミコンゲームになりました．では，ファミコンゲームは，永遠に遊ぶことが可能でしょうか．ファミコンが生産中止になった現在では，いずれ世界中のファミコンが壊れて，ファミコンゲームを遊ぶことは，不可能になってしまうでしょう．ただ，エミュレータというソフトを使うと，それが可能になるというわけです．

エミュレータとは，あるアーキテクチャのソフトを，別のアーキテクチャ上で動作させるソフトの総称で，例えば，PC上でファミコンゲームを動作させるソフトなどのことです．つまり，ファミコンというハードと全く同じ動作をするソフトを開発し，ソースレベルで新しいアーキテクチャ（例えば，Windows XP）に移植していけば，たとえファミコンというハードが死に絶えたとしても，ファミコンゲームというソフトを動作させることは可能という理屈です．

きっかけ

ファミコンエミュレータというソフトの存在を知り，「ファミコンというハードと全く同じ動作をするソフトなどというものが，作れるのだろうか」と疑問を持ちました．ネット上には，すでにいくつかのファミコンエミュレータが存在していたので，ただ遊びたいだけあれば，それを使えばすむことだったかもしれません．ただ，1999年夏頃，この疑問に答えるために，どうしてもファミコンエミュレータを作ってみたくなりました．

最初，エミュレータなんて作ったこともなかったので，ソースが公開されているものを移植してみることから始めました．当時，C言語のソースが公開されたファミコンエミュレータは，bero氏が開発したFCEとLinuxで動作するxNESぐらいしかありませんでした．特に理由はなく，xNESをWindowsに移植してみることにしました．

開発開始

1999年夏のある土曜日だったと思います． VC++ 6.0で，空のプロジェクトを作成し，xNESのソースを流し込み，それだけでビルドしてみました．allegro関係でいろいろとエラーが出ました． allegroは，ゲームを開発するためのライブラリで，同じAPI（Application Interface）を叩けば，DOSやLinuxなどで同じソースを利用できるものです．とりあえず，allegro関係の部分をコメントアウトして，エラーが出ないようにしました．

_(2021-10-24) 1999年の夏至（夏のはじまり）の直後の土曜日は，6月26日です．_

完成したバイナリに，パブリックドメインのROMを読み込ませてみると，いろいろなメッセージが表示され，エミュレーションのコア部は，うまく動作している様子でした．さっき，allegro関係でコメントアウトした部分は，以下のような処理でした．

- 画面を描画する処理
  - VSYNC毎にVRAMの内容をアプリケーションウィンドウに表示

_(2021-10-24) 上記の記載は，中途半端であり，「同じ機能をwin32で実装しました．」等の記載が続くものと思われます．_

参考文献

- [1] 村上春樹 : 1973年のピンボール，講談社，1980年6月17日．
- [2] Eric Steven Raymond : [伽藍とバザール](https://cruel.org/freeware/cathedral.html)，光芒社，1999年7月30日．

### 1999-09-23

_(2021-10-27) 本稿は，2004年2月12日に執筆されました．_

エミュレータを初めて公開した日

1999年の秋頃，InfoNESの初版（v0.61）は完成しました．当時，オープンソースのファミコンエミュレータとしては，bero氏のFCEか，xNESぐらいしかありませんでした．InfoNESの初版は，xNESからallegro関連のコードを取り除いて，win32関連のコードを付け加えた程度のお粗末なものでした．とても遅くて，プレイできるようなレベルには達していませんでした．

_(2021-10-27) 1999年の秋分の日（秋の始まり）は，9月23日です．_

geocitiesにInfoNESの初版を公開して，10数日後，突如として大量のヒットが来るようになりました．1時間に1,500ヒットぐらいです（大量とはいえないですが）．当時，Webというダイナミズムを理解していなかったのですが，どこかのエミュレータのニュースサイトに，InfoNESの情報が公開されたらしいです．それがあっという間に，世界中のエミュサイトに伝達され，それを見たユーザが，InfoNESをダウンロードしたということらしいです．私は少し怖くなって，InfoNESの公開を停止しました．

今となっては，笑い話だが，それから1週間ぐらい，N社に訴えられるか，当局につかまるんじゃないかとおびえていました．そのときは，研修かなにかで普段使わないバス停を使っていましたた．そのバス停からの帰り道，そのことを真剣に考えたものでした．

今日，たまたま，そのバス停の前を通りかかって，鮮明にそのことを思い出しました．

### 2000-09-23

_(2021-10-27) 本稿は，2004年2月13日に執筆されました．_

エミュレータを再公開した日

2000年の秋頃，性懲りもなくInfoNESを再公開しました．それまでに，2つのことをやりました．ひとつは，InfoNESの高速化です．そして，もうひとつは，エミュレータの違法性についての調査です．

_(2021-10-27) 2000年の秋分の日（秋の始まり）は，9月23日です．_

1999年の冬頃に公開したInfoNESは，かなり遅かったです．ファミコンは，N社では，MMC（Memory Management Controller），通称では，マッパというROMを管理するモジュールを，カセット内部に持つことで発展していきました．ファミコンのI/OはメモリマップドI/Oなので，ROM領域（例：$8000）に対する書き込みをバンク切替に使ったりしていました．初期のInfoNESは，バンク切替が発生する度に，マッパ内のROMの内容を，ファミコン内のROMにコピーするという，なんともお粗末な作りになっていました．そのために，果てしなく遅かったのです．

あまりに遅かったので，InfoNESの公開中止を期に，InfoNESのコア部を変更することにしました．その頃には，オープンソースのファミコンエミュレータの数も，少しずつ増えてきていました．高速という観点から，プレステ用に開発されたpNesXを使うことを計画しました．結局，半年以上かかってしまったが，pNesXのコア部と，InfoNESのWindows依存部を結合して，サウンド部を実装した版が完成しました．その当時のWindowsでも，十分に高速でウェイトを入れないと速くてプレイできないような代物になっていました．互換性，サウンドなど，改善すべきことは，いろいろあったが，とりあえずまとまったものが完成しました．

_(2021-10-27) サウンド部は，darcnesという実装があり，そのソースを参考に実装しました．当時サウンドについては，十分な技術情報がなく，手探りで実装していきました．_

もうひとつのエミュレータの違法性についてもいろいろ調査しました．SCEIとConnecticsのプレステエミュレータ訴訟において，SCEIが敗訴した以降，日本国内においての「エミュレータは合法，ROMは違法」というのが定説になりつつあります．ただ，当時は，その判決以前であり，「エミュレータはグレー」というのが一般的な定説でした（iNESのMarat氏もFAQの中でそう書いています）．しかしながら，すでにファミコンエミュレータが，いろいろ出ている状況で，InfoNESが増えたぐらいでは，状況は変わらないだろうということで，InfoNES（v0.69）を再公開しました．

_(2021-10-27) Nothing ventured, nothing gained._

その間，InfoNESは，昼休みと終業後に開発した．夜遅く家に帰る途中，MMC3のことを考えていて，いつも通る三叉路で車に轢かれそうになったことがある．昨日の夜，その三叉路を通って，ふとそんなことを思い出した．

### 2000-12-21

_(2021-10-27) 本稿は，2004年2月19日に執筆されました．_

エミュレータを進化させていった日々

2000年の冬頃から，2001年の春頃にかけて，InfoNESはバージョンアップを繰り返しました．その頃，ファミコンエミュレータ界は，nesterが席巻していました．nesterは，オープンソースである上に，いまだかつてないほどの高い互換性，精度の高いサウンドを特徴としており，日本人の武田氏により，nesterに日本でしか販売されていないカセットのマッパをサポートした，Unofficial nester（UO nester）なども発表されていました．

_(2021-10-27) 2000年の冬至（冬の始まり）は，12月21日です．_

一方，InfoNESは，基本的なマッパしかサポートしていなかったし，サウンドの精度もあまり高くないという状況だったので，UO nesterのソースは，いい教材になりました．PPUの$2005/$2006レジスタへの書き込み，APUの矩形波，三角波，ノイズ，マッパ等のコーディングを参考にして，InfoNESは進化していきました．結果として，InfoNESの互換性，サウンドの精度は向上しました．個人的には，InfoNESは，nesterと闘った（競争した）と思っていますが，nester陣営はそんなこと微塵も思ってないと思います．

ただ，InfoNESのソースは，前述したように，エミュレーションコアと，機種依存部が綺麗に分かれており，高速に動作するように記述されていました．これは，InfoNESがベースとしたpNesXの特徴でもあったが，InfoNESが進化していく段階でも，その特徴は失わないように，慎重に進化させていきました．これが，その後の展開に大きく影響することになりました．ある程度まとまった版として，v0.72Jをリリースしたように記憶しています．

時を同じくして，はーめるんさんが，PlayStation2上で動作するLinux（PS2/Linux）を動かし始めていました．『PS2/Linux上で，InfoNESが動くと面白いね』って話になって，x86/LinuxにInfoNESを移植してみることにしました．移植は，比較的簡単でした．なにしろ，エミュレーションコアの部分は，GCCでコンパイルしただけで動作したし，Linux用の機種依存部は，GTKをベースとして，サウンドはOSSを使って，コーディングして，すぐに動作するようになった．Linux版のサウンドコードは，比較的うまく動作していて，むしろWindows版より，いいサウンドが鳴るほどでした．結果として，InfoNESは，Windowsとx86/Linuxで動作するようになった．

また，PS2/Linuxへの移植は，はーめるん氏が担当してくれたのですが，驚くほど簡単でした．なんと，makeするだけで，動作してしまったのです．いまだに，PS2/Linux上でInfoNESが動いているのを見たことはないのですが，速度はフレームスキップが8程度で動作するらしいです．

追伸　

一昨日，昨日と，ビットバレーは春の陽気だったが，InfoNESを進化させていったときも，こんな春の陽気だったなと，ふと思い出しました．

### 2001-03-13

_(2021-11-03) 本稿は，2004年4月12日に執筆されました．_

ファミコンエミュレータが輝いていた頃

あの頃の熱気はある意味異常だったのかもしれません．武田さんが，UOnesterで活躍されている頃，ファミコンエミュレータ界は，活況を呈していました．

_(2021-11-03) UOnesterは，2001年03月13日に開発が開始されています．_

武田さんは，「編集者」というかなり控えめな表現をするかもしれないが，nesterという非常に完成度の高いファミコンエミュレータのコアをベースにして，国産カセット（マッパ）をサポートするというコンセプトを打ち出したという意味において，UOnesterは凄かったと思います．しかも，emulation9の管理人さんと協力して，掲示板で動作報告を募集するなど，多くの人を巻き込んだということも特筆すべきでしょう．つまり，UOnesterは，そういったコンセプトのもとに，エミュレータ作者の手元に分散していた情報を集約して，しかも，オープンソースという形式で共有してしまったのです．ひとつのムーブメントだったといってもいいかもしれません．それが，NNNesterJ等に進化していったわけです．

一方，InfoNESは，組み込み機器向けに，高速化を意識しつつも，高機能化ということで，UOnesterのマッパ関連・サウンド関連の情報を参考させてもらいました．InfoNESについてだけいっても，UOnesterが与えたインパクトは，本当に大きかったです．

そんなことを，海沿いの高速列車に乗りながら，ふと考えました．海沿いの高速列車は，ビル群が聳え立つ「携帯の谷」に続きます．本当に久しぶりな気がします．ここは時間が止まっているようです．

### 2001-06-21

_(2021-10-27) 本稿は，2004年5月23日に執筆されました．_

Linux版の開発を時系列(*)におさらいしておきましょう．

2001年夏頃，InfoNESをLinuxに移植しようという話が盛り上がりました．きっかけは，はーめるん氏が，PS2/Linuxを宣伝し始めたことでした．まず，InfoNESをPS2/Linuxに移植しようという話が，掲示板で盛り上がり，PS2/Linuxの発売に先立って，事前にx86/Linuxへ移植しておこうという話になりました．

_(2021-10-27) 2001年の夏至（夏のはじまり）は，6月21日です．_

x86/Linuxへの移植は，簡単でした．GTK+でGUIを，OSSでサウンドを実装するだけでした．たしか，InfoNES v0.76Jを，2001年秋頃にリリースしたように記憶しています．Linux版として，開発をすすめたということなかったのですが，Windows版，WinCE版とソースを共用化していたので，InfoNESコア（Windows版，WinCE版）が進化すると，同時にLinux版も進化していきました．2002年冬頃には，Linux用のファミコンエミュとしては，マッパサポート数が多く，それなりに使われるようになっていました．

(*)ブロッグとは，すなわち時系列なものなのですが．

### 2001-12-31

_(2021-10-27) 本稿は，2004年2月23日に執筆されました．_

はじめて組み込み機器に移植された日

それは突然のメールから始まりした．これ以降，いろんなことが，突然に，メールで始まることになるのですが，その話はまたの機会にします．

当時，はーめるんさんが主催する掲示板では，私とはーめるんさんが，InfoNESの移植について議論を重ねていました．そのなかで，『InfoNESのWinCEへの移植は，ひゅ～さんにお願いする』という主旨の議論がありました．私とはーめるんさん，ひゅ～さん，は，昔の同僚で，ひゅ～さんは，JavaCardをWinCEに移植したエンジニアでした．

そのメールは，『InfoNESをWinCEに移植するのは，ひゅ～さんという人になっているが，自分が挑戦したいので，ソースを送ってほしい』という内容でした．当時，InfoNESは，オープンソースではなかったのだ．機会は均等にということで，思い切ってInfoNESをオープンソース化することにしました．ライセンス条項は，GPL（GNU Public License）にしました．そして，もぺお氏に，『オープンソース化したので，WinCEへの移植をお願いします』というメールを返しました．2001年の暮れだったように記憶しています．InfoNESは，当時，v0.76Jというバージョンで，サウンド精度の向上，マッパーサポート，互換性の向上などが盛り込まれていました．

_(2021-10-29) 2001年の大晦日（暮れ）は，12月31日です．_

それから，1週間後，もぺお氏からまたメールが来ました．『P/PCへの移植が完了しました』という内容だったので，『できれば，ソースも公開してください』というメールを返しました．結局，もぺお氏のページで，バイナリ（ARM，MIPS，SH3）とソースが公開されました．当時，P/PCでまともに動作するファミコンエミュレータは，PocketNESぐらいだった（ように記憶している）ので，結構話題になりました．

1週間でP/PC版が完成して，オープンソースの威力をまざまざと見せ付けられた感がありましたが，驚きはそれでは終わりませんでした．nagamidori氏が，もぺお氏のソースをベースにして，サウンド音質を向上させ，キー設定機能を追加させた，P/PC2002版を開発して，公開したのです．この移植は，なかなか見事でした．そして，最終的に，2003年夏頃に公開したv0.91Jでは，このもぺお氏とnagamidori氏のソースを統合して，正式にP/PC 2002版をリリースさせてもらいました．ここでも，nester系との闘い（競争）がありました．事情はよく分からないが，現状，P/PC 2002で動作するnester系のファミコンエミュレータが公開を停止していたため，P/PC 2002，2003ではInfoNESが広く使われている（ようです）．

しかし，これで話は終わらないのです．今度は，にゃごす氏が，もぺお氏のソースをベースにして，サウンド音質を向上させた，H/PC版を開発したというのです．また，fujikawa氏は，にゃごす氏のソースをベースに，l'agenda版を開発しました．結果として，InfoNESは，WinCEベースのOSとして，P/PC，P/PC2002，H/PC，l'agendaの4プラットフォームで動作することになりました．ややこしいのですが，WinCEというのは，OSコアの部分を指す用語で，Microsoftによる，手帳サイズの実装が，P/PCとP/PC2002，PCサイズの実装が，H/PC，カシオによる，手帳サイズの実装が，l'agenda（日本ではBE-500，米国ではBE-300）となるらしいです．

余談だが，l'agendaは，秋葉原等で，非常に安く売られているらしく，その一方で速度的にもまずまずなので，依然として人気があるらしいです．そういう意味で，InfoNESへの需要もあるらしく，いろいろ問い合わせが来たりします．ただ，l'agenda版は，InfoNESのコアとしては古く心苦しいです．どなたか，v0.91版等を移植してくださる方がいると嬉しいです．

追伸

春の陽気に誘われながら，新しく開通した横浜高速鉄道に乗りながら，そんなことを走馬灯のように思い出したのでした．

### 2002-12-22

_(2021-10-27) 本稿は，2004年3月1日に執筆されました．_

はじめてゲーム機に移植された日

2002年冬頃，メールが来ました．『InfoNESをGP32に移植した』という内容でした．GP32というのは，韓国製のGamePark32という名前のゲーム機であり，GBAを意識した設計になっており，CPUも同じARM系でした．ただ，クロック周波数は，最大133MHzとGBAの約10倍高速です．また，SDKが無料で配布されており，開発したゲームを配布することができました．そういうことを勘案すると，InfoNESが移植されたとしても，それほど驚くべきことではありません．

_(2021-10-29) 2002年の冬至（冬のはじまり）は，12月22日です．_

しかし，そのメールを読んだときは，驚きました．作者は米国人でした．地球は青く丸い星で，インターネットはどこまでもつながっていのです．それだけのことです．当時，InfoNES AdvanceというpNesXをGameBoy Advanceに移植したものを試しで開発していたが，正式なInfoNESの移植ではなかったし，速度も遅く実用的とはいえませんでした．

![](https://github.com/jay-kumogata/InfoNES/blob/master/screenshots/infones_gba.png)

_(2021-10-27) 現在では，SNSで米国人と交流することは，さして困難ではないのです．が，当時は，まだ珍しい事例だったのだと想像します．_

InfoNESをGP32に移植したものは，fNES32という名称で配布されていました．InfoNESが初めてゲーム機で動作した瞬間でした．作者は，fNES32をベースにnester系のサウンド部を結合させたらしいが，結局配布されませんでした．その後，英国に住む北欧出身のプログラマが，InfoNESをGP32に移植しました．2度のバージョンアップを繰り返して，最終的にソースも公開されました．当時，GP32で動作するファミコンエミュレータは，fNES32とInfoNES GP32だけでしたが，どちらもInfoNESベースでした．ここでも，InfoNESのソースが高速である特徴が活かされていました．

ところで，何度か，GP32を買おうと思いました．GP32のエミュレータ（GeePee32）でInfoNESが動作するところは見ていましたが，実機では見たことがありません．面白いので，ちょっと買ってみようと思い，秋葉原のメッセサンオーカオス館に行ってみましたが，売り切れていました．また，力生というネットショッピングで買おうと思ったが，よく分からなくなったので，止めてしまいました．現在は，興味を失ったが，その時に買っておけば，良かったかなとも思います．

いまでこそ，ゲーム機で，ファミコンエミュレータが動作することは，普通のことだが，当時は，少しはエキサイティングなことだったのです．今日は，また，寒さが戻ったが，そのときも寒かったなとふと思い出したわけでした．

_(2021-10-27) 最新ゲーム機上で，過去のゲームが動作するという，いまでいう「アケアカ」のような事例が，当時から存在していたのです．_

### 2003-06-22

_(2021-10-27) 本稿は，2004年5月23日に執筆されました．_

はじめてLinuxディストリビューションに含まれた日

2003年夏頃，InfoNESがディストリビューションに含まれることになりました．gentooというディストリビューションでした．「あなたのソフトを，うちのディストリビューションに含めます」みたいな連絡はありませんでした．作者には，いちいち許可を求めたりはしないみたいです．Linuxのディストリビューションというのは，結構いい加減なものなのだと，少し不思議な気持ちになりました．

_(2021-10-27) 2003年の夏至（夏のはじまり）は，6月22日です．_

5月なのに肌寒く，北朝鮮な昼下がりに，そんなことを少し思い出してみたりしています．

_(2021-10-26) この時期，北朝鮮に拉致された日本人が数名戻ってきて，北朝鮮の話題で持ちきりになっていました．_
_それを，「北朝鮮な昼下がり」と表現したものと思われます．_

_(2021-11-03) ここまでは，開発記と称していますが，記憶に頼った内容でした．これ以降は，本来の開発記としての内容となります．_

### 2004-05-01

v0.93Jの更新状況です．
- (1) PocketPC2003に正式対応
  - いままでは，PocketPC2002用がPocketPC2003でも動くということでしたが，今回は正式にPocketPC2003に対応しました．
- (2) 十字キー設定に対応
  - 十字キーの設定がうまくいかないという不具合を修正しました．
- (3) サンプリングレート11025Hzに対応
  - 携帯電話のような非力なハードウェアに移植することを考えて，サンプリングレート11025Hzに対応しました．
- (4) その他
  - マッパサポート（#61,#200,#201,#202）しました．

### 2004-05-06

Revisions in v0.93E are
- (1) Offically supports PocketPC2003
  - Before v0.91E, it is only for PocketPC2002, but it works well on PocketPC2002. In this release, it offically supports PocketPC2003.
- (2) Fixed key configuration
  - The bug of key configuration of arrow keys has been fixed.
- (3) Supports sampling rate 11025Hz
  - Regarding a porting to low-spec hardware, like cellular phone, it supports sampling rate 11025Hz.
- (4) Misc
  - Mapper #61,#200,#201,#202 are added.

### 2005-07-03

何日か前のコメントにもありましたが，Mapper #4等で，画面下部の点数表示が正しく表示されないバグがあります．InfoNES v0.95Jをリリースしてから，少し解析してみました．まだ，よく分かってないので，中間報告です．

点数表示の時に使われるロジック

Mapper #4の場合（ほかのMapperでも），スキャンラインベースのIRQ（Interrupt ReQest: 割込み要求）を持っています．つまり，適当なスキャンラインでIRQを発生させることができるということです．大体，以下のようなロジックで点数を表示させているようです．

- スキャンライン: 0（ゲーム画面が開始）
  - ゲーム画面で利用するキャラデータを選択（$8000，$8001書き込み等）
  - スクロール値（$2005書き込み等）
  - ゲーム画面を表示
- スキャンライン: 160（点数表示が開始）
  - IRQ発生，割り込みハンドラで以下の処理
  - ゲーム画面で利用するキャラデータを選択（$8000，$8001書き込み等）
  - スクロール値（$2005書き込み等）
  - 不明（$2006書き込み等）
  - 点数表示
- スキャンライン: 243（VBLANKが開始）

問題なのは，点数表示の開始時点で，$2006に書き込みがあるのですが，$2007へは書き込みはないため，なんの目的で$2006へ書き込んでいるかが，いまいち不明なことです（詳しい方，コメントお願いします）．

### 2023-03-19

25年以上前に書いたコードが，欧州の携帯ゲーム機で動いているという[知らせ](https://twitter.com/frenskefrens/status/1637439574375800832)が届きました．
過去にも似たような知らせがありましたが，毎回少し不思議な気分になります．
[PicoSystem](https://shop.pimoroni.com/products/picosystem)というRP2040ベースの携帯ゲーム機を使用しているようです．
[Known source ports](https://github.com/jay-kumogata/InfoNES/tree/master#known-source-ports)の方には，追加しました．

以上
